import axios from "axios";
import Swal from "sweetalert2";

import { toastMessage, warningMessage } from "./utilities/message.js";
import { getToken, errorHandle } from "./utilities/authorization.js";
import { modifyProductData } from "./utilities/modification.js";

const { VITE_APP_SITE } = import.meta.env;

// init

function init() {

    const token = getToken();
    
    if (!token) {
        toastMessage('warning','Ë´ãÂÖàÁôªÂÖ•','login.html');
    } else {
        const userId = JSON.parse(localStorage.getItem('userData')).id;
        axios.get(`${VITE_APP_SITE}/640/user/${userId}/carts?_expand=product`, {
            headers : {
                "authorization": `Bearer ${token}`
            }
        })
        .then((res)=>{
            renderData(res.data);
        })
        .catch((error)=>{ errorHandle(error) })
    }

}

init();

function renderData(data) {

    const cart = document.querySelector('#cart');
    let str = '';

    if (data.length === 0) {

        str = /*html*/`
        <div class="col-12">
        <p class="alert bg-tertiary text-center m-0">
        Ë≥ºÁâ©ËªäÂÖßÈÇÑÊ≤íÊúâÂïÜÂìÅÂì¶ÔºÅÂéª<a href="products.html">ÈÄõÈÄõ</a>ÂêßÔºÅ
        </p>
        </div>`

        cart.innerHTML = str;

    } else {

        str = /*html*/`
        <div class="col-md-9 mb-6">
            <ul id="main-content" class="list-group ps-0"></ul>
        </div>
        <div class="col-md-3">
            <div class="position-sticky top-0">
                <div class="bg-secondary rounded-1 p-6 lh-lg">
                    <h3 class="text-center mb-9">Á∏ΩË®à</h3>
                    <!-- Â∞èË®à -->
                    <div class="d-flex justify-content-between">
                        <p class="fw-bold">Â∞èË®à</p>
                        <p style="width: 40%" class="d-flex justify-content-between">
                            <span>NTÔºÑ</span>
                            <span id="subtotal"></span>
                        </p>
                    </div>
                    <!-- ÈÅãË≤ª -->
                    <div class="d-flex justify-content-between">
                        <p class="fw-bold">ÈÅãË≤ª</p>
                        <p style="width: 40%" class="d-flex justify-content-between">
                            <span>NTÔºÑ</span>
                            <span id="delivery-fee"></span>
                        </p>
                    </div>
                    <hr>
                    <!-- Á∏ΩË®à -->
                    <div class="d-flex justify-content-between align-items-center fw-bold">
                        <p>Á∏ΩË®à</p>
                        <p class="fs-5">
                        <span>NTÔºÑ</span><span id="total"></span>
                        </p>
                    </div>
                </div>
                <div class="d-flex justify-content-end align-items-center gap-2 mt-6">
                    <input type="checkbox" id="delivery-confirm">ÊàëÂ∑≤Ë©≥Èñ±‰∏¶ÂêåÊÑè
                    <a href="#"
                       class="text-decoration-none fw-bold text-orange"
                       data-bs-toggle="modal"
                       data-bs-target="#deliveryInfoModal">
                    ÂØÑÈÄÅË™™Êòé</a>
                </div>
                <div class="mt-6 text-end">
                    <button id="confirm" class="btn btn-primary">‰∏ã‰∏ÄÊ≠•</button>
                </div>
            </div>
        </div>
        `
        cart.innerHTML = str;

        renderCart(data);
        showTotalCost(data);

    }

}

function renderCart(data) {

    const main = document.querySelector('#main-content');
    let content = '';

    data.forEach(item => content += /*html*/`
    <li data-num=${item.id} class="list-group-item shadow-sm py-md-0 py-8">
        <div class="row align-items-center">
            <!-- 1 -->
            <div class="col-md-1 col-2 text-center">
                <button class="delete btn d-flex align-items-center p-0 ms-md-3">
                    <span class="material-icons fs-3">delete</span>
                </button>
            </div>
            <!-- 2 -->
            <div class="d-md-block d-none col-md-2">
                <a href="products-detail.html?id=${item.product.id}" class="text-decoration-none">
                <img src="${item.product.image[0] || "https://fakeimg.pl/291x291/?text=üç∞&font=noto"}"
                     alt="${item.product.name}"
                     class="rounded-2">
                </a>
            </div>
            <!-- 3 -->
            <div class="col-md-3 col-6 d-flex justify-content-between align-items-center">
                <a href="products-detail.html?id=${item.product.id}" class="text-decoration-none">
                    <h3 class="fs-6 mb-0">${item.product.name}<span class="d-md-inline-block d-none">Ôºè${item.product.size}</span></h3>
                </a>
                <div class="d-md-none d-block">ÔΩò${item.qty}</div>
            </div>
            <!-- 4 -->
            <div class="col-md-4 d-md-block d-none">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn p-0 mt-2"><span class="material-icons fs-2">add_circle</span></button>
                        <input class="form-control py-md-2 py-1 px-3 text-center" type="number" min="1" max="10" value=${item.qty}>
                        <button class="btn p-0 mt-2"><span class="material-icons fs-2">remove_circle</span></button>
                    </div>
                    <button class="changeQuantity btn btn-sm btn-primary px-2">‰øÆÊîπÊï∏Èáè</button>
                </div>
            </div>
            <!-- 5 -->
            <div class="col-md-2 col-4">
                <h4 id="cost" class="d-flex justify-content-between fs-6 px-md-2 px-0 mb-0">
                <span>NTÔºÑ</span>
                <span>${item.product.price*item.qty}</span>
                </h4>
            </div>
        </div>
    </li>
    `
    )

    main.innerHTML = content;

    const confirm = document.querySelector('#confirm');
    confirm.addEventListener('click', (event) => {
        if (data.some(item => !item.product.forSale)) {
            warningMessage('OOPS', 'Ë≥ºÁâ©ËªäÂÖßÊúâÂÆåÂîÆÁöÑÂïÜÂìÅÔºåË´ãÂà™Èô§ÂæåÂÜçÈáçÊñ∞ÁµêÂ∏≥')
        } else {
            nextStep(event,data);
        }
    }, false);
    
    const listItems = [...main.children];
    listItems.forEach(item => {
        const currentQty = document.querySelector(`[data-num="${item.dataset.num}"] input`).value;
        cartListener(item, currentQty);
    });

}

function cartListener(element, currentQuantity) {

    element.addEventListener('click', function(e){
        const { target } = e;
        const id = target.closest('li').dataset.num; // !important
        if (!target.closest('.btn')) { return }
        else {
            
            e.preventDefault();
            const token = getToken();

            if (target.textContent.includes('delete')) {
            
                axios.delete(`${VITE_APP_SITE}/640/carts/${id}`, {
                    headers: {
                        "authorization": `Bearer ${token}`
                    }
                })
                .then((res)=>{
                    toastMessage('success','Âà™Èô§ÊàêÂäü');
                    init();
                })
                .catch((error)=>{ errorHandle(error) })

            } else {

                const qty = document.querySelector(`li[data-num="${id}"] input`); // !important

                if (target.textContent.includes('add')) {
                    qty.value > 9 ? qty.value : qty.value++;
                } else if (target.textContent.includes('remove')) {
                    qty.value < 2 ? qty.value : qty.value--;
                } else if (target.classList.contains('changeQuantity')) {

                    function checkValue(value) {
                        if (isNaN(value)) {
                            toastMessage('warning','Ë´ãËº∏ÂÖ•ÈòøÊãâ‰ºØÊï∏Â≠ó');
                            qty.value = currentQuantity;
                            return false;
                        } else if (!Number.isInteger(value) || value <= 0){
                            toastMessage('warning','Ë´ãËº∏ÂÖ•Â§ßÊñºÈõ∂ÁöÑÊ≠£Êï¥Êï∏');
                            qty.value = currentQuantity;
                            return false;
                        }
                        return true;
                    }

                    if (currentQuantity == qty.value) {
                        toastMessage("question","Êï∏ÈáèÊ≤íËÆäÂì¶ („ÜÜ·¥ó„ÜÜ)"); // Êï∏ÈáèÊ≤íÊõ¥Êñ∞ÊôÇÔºå‰∏çÈúÄË¶ÅÁôºÈÄÅÁ∂≤Ë∑ØË´ãÊ±Ç
                    } else if (qty.value > 10) {
                        warningMessage('Êï∏ÈáèÈÅî‰∏äÈôê','Â¶ÇÊûúÈúÄË¶ÅÂ§ßÈáèË®ÇË≥ºÔºåË´ãÁõ¥Êé•ËàáÊàëÂÄëËÅØÁµ°');
                    } else {
                        checkValue(+qty.value) &&
                        axios.get(`${VITE_APP_SITE}/640/carts/${id}`, {
                            headers: {
                                "authorization": `Bearer ${token}`
                            }
                        })
                        .then((res)=>{
                            let targetProduct = res.data;
                            targetProduct = { ...targetProduct, qty: +qty.value };
                            return axios.patch(`${VITE_APP_SITE}/640/carts/${id}`, targetProduct, {
                                headers: {
                                    "authorization": `Bearer ${token}`
                                }
                            })
                        })
                        .then((res)=>{
                            toastMessage('success','Êï∏Èáè‰øÆÊîπÊàêÂäüÔºÅ')
                            init();
                        })
                        .catch((error)=>{ errorHandle(error) })
                    }

                }

            }
        
        }
    })

}

function showTotalCost(data) {

    const subtotal = document.querySelector('#subtotal');
    const deliveryFee = document.querySelector('#delivery-fee');
    const total = document.querySelector('#total');

    subtotal.textContent = data.reduce((acc,curr) => { 
       return acc + (Number(curr.product.price) * curr.qty)
    }, 0);

    deliveryFee.textContent = 150;

    total.textContent = (+subtotal.textContent) + (+deliveryFee.textContent)

}

function nextStep(e,data) {

    if (e.target.textContent === '‰∏ã‰∏ÄÊ≠•') {

        const title = document.querySelector('#process-title');
        e.target.textContent = 'Áµê„ÄÄÂ∏≥';
        title.textContent = 'Â°´ÂØ´ÂØÑÈÄÅË≥áË®ä';

        const main = document.querySelector('#main-content');
        let content = '';
        content += /*html*/`
        <div class="border border-primary rounded-1 px-6 py-7">
            <form id="order-form" class="d-flex flex-column gap-7">
                <div class="d-flex gap-2">
                    <!-- method -->
                    <p class="fw-bold">ÂèñË≤®ÊñπÂºèÔºö</p>
                    <input type="radio" name="method" id="ÂÆÖÈÖçÂà∞Â∫ú" value="ÂÆÖÈÖçÂà∞Â∫ú">
                    <label name="method" for="ÂÆÖÈÖçÂà∞Â∫ú">ÂÆÖÈÖçÂà∞Â∫ú</label>
                    <input type="radio" name="method" id="‰æÜÂ∫óÂèñË≤®" value="‰æÜÂ∫óÂèñË≤®">
                    <label name="method" for="‰æÜÂ∫óÂèñË≤®">‰æÜÂ∫óÂèñË≤®</label>
                </div>
                <div class="d-flex gap-2">
                    <!-- payment -->
                    <p class="fw-bold">‰ªòÊ¨æÊñπÂºèÔºö</p>
                    <input type="radio" name="payment" id="Ë≤®Âà∞‰ªòÊ¨æ" value="Ë≤®Âà∞‰ªòÊ¨æ">
                    <label for="Ë≤®Âà∞‰ªòÊ¨æ">Ë≤®Âà∞‰ªòÊ¨æ</label>
                </div>
                <div class="d-flex flex-md-row flex-column align-items-md-center gap-2">
                    <!-- receiver -->
                    <label for="receiver" class="fw-bold mb-md-0 mb-3">Êî∂‰ª∂‰∫∫ÂßìÂêçÔºö</label>
                    <input type="text" id="receiver" class="form-control w-25 px-2 py-1">
                    <div><input type="checkbox" id="useMemberName" class="me-2">ÂêåÊúÉÂì°Ë≥áÊñô</div>
                </div>
                <div class="d-flex flex-md-row flex-column align-items-md-center gap-2">
                    <!-- phone -->
                    <label for="phone" class="fw-bold mb-md-0 mb-3">Êî∂‰ª∂‰∫∫ÈõªË©±Ôºö</label>
                    <input type="tel"
                           id="phone"
                           class="form-control w-25 px-2 py-1"
                           placeholder="Ë´ãÂ°´ÂØ´ÂúãÂÖßÁöÑÊâãÊ©üËôüÁ¢º"
                           value="0912987654">
                </div>
                <div class="d-flex flex-md-row flex-column align-items-md-center gap-2">
                    <!-- address -->
                    <label for="address" class="fw-bold mb-md-0 mb-3">Êî∂‰ª∂‰∫∫Âú∞ÂùÄÔºö</label>
                    <input type="text"
                           id="address"
                           class="form-control w-50 px-2 py-1"
                           placeholder="Ë´ãÂ°´ÂØ´ÂúãÂÖßÁöÑÂú∞ÂùÄ"
                           value="Âè∞ÂçóÂ∏ÇÊù±ÂçÄÂ§ßÂ≠∏Ë∑Ø‰∏ÄËôü">
                </div>
                <div class="d-flex flex-md-row flex-column align-items-md-center gap-2">
                    <!-- shippingTime -->
                    <p class="fw-bold mb-md-0 mb-3">ÊåáÂÆöÊî∂Ë≤®ÊôÇÊÆµÔºö</p>
                    <div>
                        <input type="radio" name="shippingTime" id="‰∏çÊåáÂÆö" value="‰∏çÊåáÂÆö">
                        <label name="shippingTime" for="‰∏çÊåáÂÆö">‰∏çÊåáÂÆö</label>
                        <input type="radio" name="shippingTime" id="ante-meridiem" value="‰∏≠ÂçàÂâç">
                        <label name="shippingTime" for="ante-meridiem">‰∏≠ÂçàÂâç</label>
                        <input type="radio" name="shippingTime" id="post-meridiem" value="‰∏ãÂçàÂÖ©ÈªûÔΩûÂÖ≠Èªû">
                        <label name="shippingTime" for="post-meridiem">‰∏ãÂçàÂÖ©ÈªûÔΩûÂÖ≠Èªû</label>
                    </div>
                </div>
            </form>
        </div>`
        main.innerHTML = content;
    
        const useMemberName = document.querySelector('#useMemberName');
        useMemberName.addEventListener('change', function(e){
            if (e.target.checked) {
                const userName = JSON.parse(localStorage.getItem('userData')).name;
                receiver.value = userName;
            } else {
                receiver.value = '';
            }
        })

    } else if (e.target.textContent ==='Áµê„ÄÄÂ∏≥') {

        const method = document.querySelector('input[name="method"]:checked');
        const payment = document.querySelector('input[name="payment"]:checked');
        const receiver = document.querySelector('#receiver');
        const phone = document.querySelector('#phone');
        const address = document.querySelector('#address');
        const shippingTime = document.querySelector('input[name="shippingTime"]:checked');
        const deliveryConfirm = document.querySelector('#delivery-confirm');

        function checkInput(element) {

            if (element?.id === 'delivery-confirm' && !element?.checked) {
                toastMessage('warning','Ë´ãË©≥Èñ±‰∏¶ÂêåÊÑèÂØÑÈÄÅË™™Êòé');
                return false;
            } else if (!element?.value) {
                toastMessage('warning','Ë´ãÁ¢∫ÂØ¶Â°´ÂØ´ÊâÄÊúâÁöÑÊ¨Ñ‰Ωç');
                return false;
            } else if (element?.id === 'phone') {
                if (!/^09(\d){8}/.test(element.value)) {
                    toastMessage('warning','ÊâãÊ©üËôüÁ¢ºÊ†ºÂºè‰∏çÊ≠£Á¢∫'); 
                    return false;
                }
            }
            return true;

        }

        checkInput(method)
        &&
        checkInput(payment)
        &&
        checkInput(receiver)
        &&
        checkInput(phone)
        &&
        checkInput(address)
        &&
        checkInput(shippingTime)
        &&
        checkInput(deliveryConfirm)
        &&
        (function(){
            const deliveryInfo = {
                receiver: receiver.value,
                phone: phone.value,
                address: address.value,
                payment: payment.value,
                method: method.value,
                shippingTime: shippingTime.value,
            }
            completeOrder(data, deliveryInfo);
        })();

    }
}

function completeOrder(data, info) {
    Swal.fire({
        icon: 'warning',
        title: 'Á¢∫ÂÆöÈÄÅÂá∫Ë®ÇÂñÆÔºü',
        text: 'ÊèêÈÜíÊÇ®ÔºåÊåâ‰∏ãÈÄÅÂá∫‰πãÂæåÂç≥Ë¶ñÁÇ∫‰∫§ÊòìÊàêÁ´ã',
        position: 'center',
        allowOutsideClick: false,
        /* cancel */
        showCancelButton: true,
        cancelButtonColor: '#D1741F',
        cancelButtonText: 'ÂÜçÊÉ≥ÊÉ≥Áúã',
        /* deal with AJAX */
        confirmButtonColor: '#A37A64',
        confirmButtonText: 'ÈÄÅÂá∫Ë®ÇÂñÆ',
        showLoaderOnConfirm: true,
        preConfirm: async () => {
            try {
                const token = getToken();
                const total = document.querySelector('#total').textContent;
                data = data.map(item => { return { ...item, product: modifyProductData(item.product) } });
                const orderInfo = {
                    orderNum: new Date().getTime()+`0${data[0].userId}`,
                    content: data,
                    total: Number(total),
                    info,
                    createdTime: new Date().getTime(),
                    userId: data[0].userId,
                    isFinished: false,
                };
                axios.post(`${VITE_APP_SITE}/640/orders`, orderInfo, {
                    headers: {
                        "authorization": `Bearer ${token}`
                    }
                })
                .then((res)=>{
                    return data.forEach(item => {
                        axios.delete(`${VITE_APP_SITE}/640/carts/${item.id}`, {
                            headers: {
                                "authorization": `Bearer ${token}`
                            }
                        })
                    })
                })
            } catch(error) { errorHandle(error) }
        }
    }).then((result)=>{
        if (result.isConfirmed) {
            Swal.fire({
                icon: 'success',
                title: 'Terima kasihÔºÅË¨ùË¨ùÊÇ®ÁöÑË®ÇË≥ºÔºÅ',
                text: 'ÊàëÂÄëÂ∞áÁ´ãÂç≥ÁÇ∫ÊÇ®Ë£Ω‰ΩúÔºåË´ãËÄêÂøÉÁ≠âÂÄôÂïÜÂìÅÈÄÅÈÅî',
                position: 'center',
                confirmButtonColor: '#A37A64',
                timer: 3000,
            }).then(() => location.href = 'member.html')
        }
    })
}
